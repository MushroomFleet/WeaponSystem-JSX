<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Combat System Demo v2</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background: #050510; color: #e0e0e0; }
    #game-canvas { width: 100%; height: 55vh; min-height: 350px; background: linear-gradient(180deg, #000815 0%, #0a1628 100%); position: relative; cursor: crosshair; }
    #hud { position: absolute; inset: 0; pointer-events: none; font-family: 'Courier New', monospace; }
    #weapon-panel { position: absolute; left: 15px; top: 15px; }
    .weapon-box { padding: 8px 12px; background: rgba(0,0,0,0.6); border: 2px solid #333; border-radius: 5px; margin-bottom: 8px; }
    .weapon-box.active { border-color: #00ff88; background: rgba(0,255,136,0.1); }
    .weapon-box.missile-active { border-color: #ff4400; background: rgba(255,68,0,0.1); }
    .weapon-name { font-size: 14px; font-weight: bold; text-shadow: 0 0 10px currentColor; }
    .weapon-ammo { font-size: 10px; opacity: 0.8; }
    .timer-bar { width: 100%; height: 3px; background: #222; margin-top: 4px; border-radius: 2px; }
    .timer-fill { height: 100%; border-radius: 2px; }
    #targeting-mode { margin-top: 12px; padding: 6px 10px; background: rgba(0,0,0,0.5); border: 1px solid #444; border-radius: 4px; font-size: 11px; }
    #targeting-mode.auto { border-color: #ff4444; color: #ff6666; }
    #passives-panel { position: absolute; right: 15px; top: 100px; }
    .passive-box { padding: 5px 8px; border-radius: 4px; margin-bottom: 5px; font-size: 10px; }
    #target-info { position: absolute; right: 15px; top: 15px; text-align: right; font-size: 11px; }
    .target-count { font-size: 22px; color: #ff4444; text-shadow: 0 0 15px #ff4444; }
    #crosshair { position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%); }
    .crosshair-dot { width: 6px; height: 6px; background: #00ff88; border-radius: 50%; box-shadow: 0 0 10px #00ff88; }
    #message { position: absolute; top: 40%; left: 50%; transform: translate(-50%,-50%); font-size: 24px; text-shadow: 0 0 20px currentColor; opacity: 0; transition: opacity 0.3s; }
    #message.visible { opacity: 1; }
    #kills { position: absolute; right: 15px; bottom: 15px; font-size: 28px; color: #ff4444; text-shadow: 0 0 15px #ff4444; }
    .control-panel { padding: 15px; background: #0a0a18; border-top: 1px solid #1a1a30; }
    .panel-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 12px; }
    .panel-title { font-size: 1.2em; color: #00ff88; }
    .spawn-btn { padding: 5px 10px; background: rgba(255,68,0,0.2); border: 1px solid #ff4400; border-radius: 4px; color: #ff6644; cursor: pointer; font-size: 10px; }
    .spawn-btn:hover { background: rgba(255,68,0,0.4); }
    .spawn-btn.boss { border-color: #ffcc00; color: #ffdd44; }
    .sections { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
    .section-title { font-size: 12px; color: #4488ff; margin-bottom: 8px; border-bottom: 1px solid #222; padding-bottom: 5px; }
    .weapons-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; }
    .weapon-card { background: rgba(255,255,255,0.03); border: 1px solid #222; border-radius: 5px; padding: 10px; cursor: pointer; position: relative; }
    .weapon-card:hover { border-color: var(--c); background: rgba(255,255,255,0.06); }
    .weapon-card.active { border-color: var(--c); box-shadow: 0 0 10px color-mix(in srgb, var(--c) 30%, transparent); }
    .weapon-card.locked { opacity: 0.4; cursor: not-allowed; }
    .wc-name { font-size: 12px; font-weight: bold; color: var(--c); }
    .wc-desc { font-size: 9px; color: #888; margin-top: 4px; }
    .wc-badge { position: absolute; top: 5px; right: 5px; font-size: 7px; padding: 1px 4px; border-radius: 2px; background: rgba(255,136,0,0.2); color: #ff8800; }
  </style>
</head>
<body>
  <div id="game-canvas" tabindex="0">
    <div id="hud">
      <div id="weapon-panel">
        <div style="font-size:10px;color:#666;margin-bottom:6px;">WEAPONS [<span id="wtype">GUN</span>] <span id="wlock" style="color:#f44;display:none;">ðŸ”’</span></div>
        <div id="gun-box" class="weapon-box active"><div class="weapon-name" id="gun-name" style="color:#00ff88;">â—† RAPID</div><div class="weapon-ammo" id="gun-ammo">âˆž</div><div class="timer-bar" id="gun-timer" style="display:none;"><div class="timer-fill" id="gun-fill"></div></div></div>
        <div id="missile-box" class="weapon-box"><div class="weapon-name" id="missile-name" style="color:#ff4400;">â—† HELLFIRE</div><div class="weapon-ammo" id="missile-ammo">32/32</div><div class="timer-bar" id="missile-timer" style="display:none;"><div class="timer-fill" id="missile-fill"></div></div></div>
        <div id="targeting-mode" class="auto">â—‰ AUTO-LOCK</div>
      </div>
      <div id="passives-panel"></div>
      <div id="target-info"><div style="font-size:9px;opacity:0.6;">TARGETS</div><div class="target-count" id="tcount">0</div><div style="font-size:11px;color:#ff8800;" id="locks">LOCKS: 0</div></div>
      <div id="crosshair"><div class="crosshair-dot"></div></div>
      <div id="message"></div>
      <div id="kills">0</div>
    </div>
  </div>
  <div class="control-panel">
    <div class="panel-header">
      <div class="panel-title">âš” COMBAT SYSTEM v2</div>
      <div><button class="spawn-btn" onclick="spawnWave(5)">+5</button> <button class="spawn-btn" onclick="spawnWave(10)">+10</button> <button class="spawn-btn boss" onclick="spawnBoss()">â˜…Boss</button> <button class="spawn-btn" onclick="clearAll()" style="border-color:#666;color:#888;">Clear</button></div>
    </div>
    <div class="sections">
      <div>
        <div class="section-title">ðŸ”« GUN WEAPONS</div>
        <div class="weapons-grid">
          <div class="weapon-card active" style="--c:#00ff88" onclick="selectGun('RAPID')"><span class="wc-badge" style="background:rgba(0,255,136,0.2);color:#0f8;">DEF</span><div class="wc-name">RAPID</div><div class="wc-desc">Unlimited rapid-fire</div></div>
          <div class="weapon-card" style="--c:#ff8844" onclick="selectGun('FLAK')"><span class="wc-badge">10s</span><div class="wc-name">FLAK</div><div class="wc-desc">Explosive spread</div></div>
          <div class="weapon-card" style="--c:#88ccff" onclick="selectGun('LIGHTNING')"><span class="wc-badge">10s</span><div class="wc-name">LIGHTNING</div><div class="wc-desc">Chain arcs Ã—4</div></div>
          <div class="weapon-card" style="--c:#ff00ff" onclick="selectGun('BEAM')"><span class="wc-badge">10s</span><div class="wc-name">BEAM</div><div class="wc-desc">Constant laser</div></div>
          <div class="weapon-card" id="grav-card" style="--c:#9900ff" onclick="selectGun('GRAVITY')"><span class="wc-badge" style="background:rgba(153,0,255,0.2);color:#b4f;">NG+</span><div class="wc-name">GRAVITY</div><div class="wc-desc">Pull & destroy squad</div></div>
        </div>
        <div class="section-title" style="margin-top:12px;">ðŸš€ MISSILE WEAPONS</div>
        <div class="weapons-grid">
          <div class="weapon-card active" style="--c:#ff4400" onclick="selectMissile('HELLFIRE')"><span class="wc-badge" style="background:rgba(0,255,136,0.2);color:#0f8;">DEF</span><div class="wc-name">HELLFIRE</div><div class="wc-desc">Multi-lock Ã—8</div></div>
          <div class="weapon-card" style="--c:#ffffff" onclick="selectMissile('SMARTBOMB')"><span class="wc-badge">Ã—1</span><div class="wc-name">SMARTBOMB</div><div class="wc-desc">Screen clear</div></div>
          <div class="weapon-card" style="--c:#ffff00" onclick="selectMissile('BUSTER')"><span class="wc-badge">Ã—1</span><div class="wc-name">BUSTER</div><div class="wc-desc">Boss killer</div></div>
          <div class="weapon-card" style="--c:#ff6600" onclick="selectMissile('BARRAGE')"><span class="wc-badge">20s</span><div class="wc-name">BARRAGE</div><div class="wc-desc">Unlimited missiles</div></div>
          <div class="weapon-card" style="--c:#00ffff" onclick="selectMissile('THOR')"><span class="wc-badge">15s</span><div class="wc-name">THOR</div><div class="wc-desc">Orbital strike</div></div>
        </div>
      </div>
      <div>
        <div class="section-title">âš¡ PASSIVE POWERUPS (30s)</div>
        <div class="weapons-grid">
          <div class="weapon-card" style="--c:#ffaa00" onclick="activatePassive('MULTILOCK')"><span class="wc-badge" style="background:rgba(68,136,255,0.2);color:#8af;">30s</span><div class="wc-name">MULTI-LOCK</div><div class="wc-desc">Lock all, fire at all</div></div>
          <div class="weapon-card" style="--c:#00ffff" onclick="activatePassive('OVERDRIVE')"><span class="wc-badge" style="background:rgba(68,136,255,0.2);color:#8af;">30s</span><div class="wc-name">OVERDRIVE</div><div class="wc-desc">2Ã— speed, 50% CD</div></div>
          <div class="weapon-card" style="--c:#4488ff" onclick="activatePassive('ACTIVE_ARMOR')"><span class="wc-badge" style="background:rgba(68,136,255,0.2);color:#8af;">30s</span><div class="wc-name">ACTIVE ARMOR</div><div class="wc-desc">90% damage reduction</div></div>
        </div>
        <div style="margin-top:12px;padding:10px;background:rgba(0,0,0,0.3);border-radius:5px;font-size:10px;">
          <div style="color:#00ff88;margin-bottom:6px;">ðŸŽ® CONTROLS</div>
          <div>WASD - Move | Mouse - Aim | Click - Fire</div>
          <div>F - Switch | TAB - Lock | Q/E - Cycle</div>
          <div style="margin-top:8px;"><input type="checkbox" id="unlock-grav" onchange="toggleGravity()"> <label for="unlock-grav" style="color:#b8f;">ðŸ”“ Unlock Gravity (NG+)</label></div>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
    const GUNS={RAPID:{name:'RAPID',rate:100,dmg:10,spd:80,life:2000,spread:0,cnt:1,inf:true,col:'#00ff88'},FLAK:{name:'FLAK',rate:250,dmg:15,spd:60,life:1500,spread:0.4,cnt:8,dur:10000,aoe:5,col:'#ff8844'},LIGHTNING:{name:'LIGHTNING',rate:150,dmg:8,spd:120,life:800,spread:0.1,cnt:1,dur:10000,chain:4,col:'#88ccff'},BEAM:{name:'BEAM',rate:0,dmg:50,dur:10000,beam:true,width:1.5,range:100,col:'#ff00ff'},GRAVITY:{name:'GRAVITY',rate:400,dmg:25,spd:80,life:2000,dur:10000,grav:25,delay:1200,col:'#9900ff',lock:true}};
    const MISSILES={HELLFIRE:{name:'HELLFIRE',rate:150,dmg:40,spd:45,turn:8,life:4000,ammo:32,reload:20000,multi:true,max:8,col:'#ff4400'},SMARTBOMB:{name:'SMARTBOMB',dmg:9999,ammo:1,clear:true,boss:true,col:'#ffffff'},BUSTER:{name:'BUSTER',dmg:500,spd:100,turn:2,life:5000,ammo:1,bossOnly:true,col:'#ffff00'},BARRAGE:{name:'BARRAGE',rate:75,dmg:30,spd:55,turn:6,life:3000,inf:true,dur:20000,col:'#ff6600'},THOR:{name:'THOR',rate:300,dmg:150,rod:true,force:50,inf:true,dur:15000,max:5,col:'#00ffff'}};
    const PASSIVES={MULTILOCK:{name:'MULTI-LOCK',dur:30000,col:'#ffaa00',lockSwitch:true,forceGun:true},OVERDRIVE:{name:'OVERDRIVE',dur:30000,col:'#00ffff'},ACTIVE_ARMOR:{name:'ACTIVE ARMOR',dur:30000,col:'#4488ff'}};
    let scene,camera,renderer,ship,reticle,enemies=[],projs=[],missiles=[],gravWells=[],beamMesh=null;
    let curGun=GUNS.RAPID,curMissile=MISSILES.HELLFIRE,wType='gun',mAmmo=32,reloading=false,reloadStart=0;
    let gunTimer=0,missileTimer=0,passives={},wLocked=false,autoLock=true,tgtIdx=0,locked=[],gravUnlocked=false,kills=0;
    let lastFire=0,lastSwitch=0,lastToggle=0,lastCycle=0;
    const input={mx:0,my:0,ax:0,ay:0,fire:false,sw:false,tog:false,cn:false,cp:false},keys={};
    function init(){const c=document.getElementById('game-canvas');scene=new THREE.Scene();scene.fog=new THREE.Fog(0x000815,50,200);camera=new THREE.PerspectiveCamera(75,c.clientWidth/c.clientHeight,0.1,1000);camera.position.set(0,8,20);camera.lookAt(0,0,-30);renderer=new THREE.WebGLRenderer({antialias:true});renderer.setSize(c.clientWidth,c.clientHeight);renderer.setClearColor(0x000815);c.appendChild(renderer.domElement);scene.add(new THREE.AmbientLight(0x334455,0.5));const d=new THREE.DirectionalLight(0xffffff,1);d.position.set(10,20,10);scene.add(d);const g=new THREE.GridHelper(200,40,0x224444,0x112222);g.position.y=-5;scene.add(g);createShip();createReticle();setupInput(c);animate();c.focus();}
    function createShip(){ship=new THREE.Group();ship.add(new THREE.Mesh(new THREE.BoxGeometry(1.5,0.5,2),new THREE.MeshStandardMaterial({color:0x4488ff,metalness:0.8})));const w=new THREE.MeshStandardMaterial({color:0x3366cc,metalness:0.8});const lw=new THREE.Mesh(new THREE.BoxGeometry(1.5,0.1,1),w);lw.position.set(-1.5,0,0);ship.add(lw);const rw=new THREE.Mesh(new THREE.BoxGeometry(1.5,0.1,1),w);rw.position.set(1.5,0,0);ship.add(rw);const e=new THREE.Mesh(new THREE.ConeGeometry(0.3,0.8,8),new THREE.MeshBasicMaterial({color:0xff8800}));e.rotation.x=Math.PI/2;e.position.z=1.2;ship.add(e);ship.add(new THREE.PointLight(0xff8800,2,4));scene.add(ship);}
    function createReticle(){reticle=new THREE.Group();const m=new THREE.MeshBasicMaterial({color:0x00ff88,side:2,transparent:true,opacity:0.8});reticle.add(new THREE.Mesh(new THREE.RingGeometry(0.8,1,4),m));const r2=new THREE.Mesh(new THREE.RingGeometry(0.5,0.6,4),m.clone());r2.rotation.z=Math.PI/4;r2.material.opacity=0.6;reticle.add(r2);reticle.position.set(0,0,-50);scene.add(reticle);}
    function setupInput(c){window.addEventListener('keydown',e=>{keys[e.code]=true;if(e.code==='Tab'){e.preventDefault();input.tog=true;}if(e.code==='KeyF')input.sw=true;if(e.code==='KeyQ')input.cp=true;if(e.code==='KeyE')input.cn=true;});window.addEventListener('keyup',e=>{keys[e.code]=false;if(e.code==='Tab')input.tog=false;if(e.code==='KeyF')input.sw=false;if(e.code==='KeyQ')input.cp=false;if(e.code==='KeyE')input.cn=false;});c.addEventListener('mousemove',e=>{const r=c.getBoundingClientRect();input.ax=((e.clientX-r.left)/r.width)*2-1;input.ay=-((e.clientY-r.top)/r.height)*2+1;});c.addEventListener('mousedown',e=>{if(e.button===0)input.fire=true;});c.addEventListener('mouseup',e=>{if(e.button===0)input.fire=false;});window.addEventListener('resize',()=>{camera.aspect=c.clientWidth/c.clientHeight;camera.updateProjectionMatrix();renderer.setSize(c.clientWidth,c.clientHeight);});}
    function spawnEnemy(x,y,z,boss=false){const e=new THREE.Group();e.userData={id:Date.now()+Math.random(),hp:boss?1000:100,boss,hr:boss?4:1.5};const s=boss?4:1;e.add(new THREE.Mesh(boss?new THREE.OctahedronGeometry(s,1):new THREE.TetrahedronGeometry(s,0),new THREE.MeshStandardMaterial({color:boss?0xffcc00:0xff4444,metalness:0.6,emissive:boss?0x664400:0x440000})));e.add(new THREE.PointLight(boss?0xffcc00:0xff4444,1,boss?10:5));e.position.set(x,y,z);scene.add(e);enemies.push(e);updateTgt();}
    function spawnWave(n){for(let i=0;i<n;i++)spawnEnemy((Math.random()-0.5)*30,(Math.random()-0.5)*15,-40-Math.random()*40);showMsg('ENEMIES!','#f44');}
    function spawnBoss(){spawnEnemy(0,0,-60,true);showMsg('â˜… BOSS â˜…','#fc0');}
    function clearAll(){enemies.forEach(e=>scene.remove(e));enemies=[];locked=[];tgtIdx=0;updateTgt();showMsg('CLEARED','#888');}
    function dmgEnemy(e){if(!e)return;const m=e.children[0].material;m.emissive.setHex(0xffffff);setTimeout(()=>m.emissive.setHex(e.userData.boss?0x664400:0x440000),100);}
    function destroyEnemy(e,grav=false){const i=enemies.indexOf(e);if(i>-1){if(grav){const f=new THREE.Mesh(new THREE.SphereGeometry(2,16,16),new THREE.MeshBasicMaterial({color:0x9900ff,transparent:true,opacity:0.8}));f.position.copy(e.position);scene.add(f);setTimeout(()=>scene.remove(f),200);}enemies.splice(i,1);scene.remove(e);kills++;document.getElementById('kills').textContent=kills;updateTgt();}}
    function selectGun(n){const g=GUNS[n];if(!g)return;if(g.lock&&!gravUnlocked){showMsg('LOCKED','#f44');return;}curGun=g;gunTimer=g.dur||0;updateGunHUD();showMsg(n,g.col);document.querySelectorAll('.weapons-grid:first-of-type .weapon-card').forEach(c=>c.classList.remove('active'));event.currentTarget.classList.add('active');}
    function selectMissile(n){const m=MISSILES[n];if(!m)return;curMissile=m;mAmmo=m.ammo||999;missileTimer=m.dur||0;reloading=false;updateMissileHUD();showMsg(n,m.col);document.querySelectorAll('.weapons-grid:nth-of-type(2) .weapon-card').forEach(c=>c.classList.remove('active'));event.currentTarget.classList.add('active');}
    function activatePassive(n){const p=PASSIVES[n];if(!p)return;passives[n]=p.dur;if(p.forceGun){wType='gun';updateWType();}if(p.lockSwitch){wLocked=true;document.getElementById('wlock').style.display='inline';}updatePassivesHUD();showMsg(p.name+'!',p.col);}
    function toggleGravity(){gravUnlocked=document.getElementById('unlock-grav').checked;document.getElementById('grav-card').classList.toggle('locked',!gravUnlocked);if(!gravUnlocked&&curGun.name==='GRAVITY')selectGun('RAPID');}
    function updateGunHUD(){document.getElementById('gun-name').textContent='â—† '+curGun.name;document.getElementById('gun-name').style.color=curGun.col;document.getElementById('gun-ammo').textContent=curGun.inf&&!curGun.dur?'âˆž':(gunTimer/1000).toFixed(1)+'s';document.getElementById('gun-timer').style.display=gunTimer>0?'block':'none';document.getElementById('gun-fill').style.width=(gunTimer/(curGun.dur||1))*100+'%';document.getElementById('gun-fill').style.background=curGun.col;}
    function updateMissileHUD(){document.getElementById('missile-name').textContent='â—† '+curMissile.name;document.getElementById('missile-name').style.color=curMissile.col;document.getElementById('missile-ammo').textContent=curMissile.inf?'âˆž':mAmmo+'/'+(curMissile.ammo||1);document.getElementById('missile-timer').style.display=missileTimer>0?'block':'none';document.getElementById('missile-fill').style.width=(missileTimer/(curMissile.dur||1))*100+'%';document.getElementById('missile-fill').style.background=curMissile.col;}
    function updateWType(){document.getElementById('wtype').textContent=wType.toUpperCase();document.getElementById('gun-box').classList.toggle('active',wType==='gun');document.getElementById('missile-box').classList.toggle('active',wType==='missile');document.getElementById('missile-box').classList.toggle('missile-active',wType==='missile');}
    function updatePassivesHUD(){const p=document.getElementById('passives-panel');p.innerHTML='';Object.entries(passives).forEach(([n,t])=>{if(t<=0)return;const c=PASSIVES[n];const d=document.createElement('div');d.className='passive-box';d.style.background=`rgba(${n==='MULTILOCK'?'255,170,0':n==='OVERDRIVE'?'0,255,255':'68,136,255'},0.2)`;d.style.border=`1px solid ${c.col}`;d.innerHTML=`<div style="color:${c.col};font-weight:bold;">${c.name}</div><div>${(t/1000).toFixed(1)}s</div><div class="timer-bar"><div class="timer-fill" style="width:${(t/c.dur)*100}%;background:${c.col}"></div></div>`;p.appendChild(d);});}
    function updateTgt(){const r=enemies.filter(e=>e&&e.position.distanceTo(ship.position)<150).sort((a,b)=>a.position.distanceTo(ship.position)-b.position.distanceTo(ship.position));if(r.length>0)tgtIdx=Math.min(tgtIdx,r.length-1);else tgtIdx=0;if(passives.MULTILOCK>0)locked=r;else if(wType==='missile'&&curMissile.multi)locked=r.slice(0,curMissile.max||8);else if(curMissile.rod)locked=r.slice(0,curMissile.max||5);else locked=r.length>0?[r[tgtIdx]]:[];document.getElementById('tcount').textContent=r.length;document.getElementById('locks').textContent='LOCKS: '+locked.length;}
    function cycleTgt(d){const now=Date.now();if(now-lastCycle<200)return;lastCycle=now;const r=enemies.filter(e=>e&&e.position.distanceTo(ship.position)<150).sort((a,b)=>a.position.distanceTo(ship.position)-b.position.distanceTo(ship.position));if(r.length>0)tgtIdx=(tgtIdx+d+r.length)%r.length;}
    function aimDir(){if(autoLock&&locked.length>0){const t=locked[tgtIdx]||locked[0];if(t)return t.position.clone().sub(ship.position).normalize();}return reticle.position.clone().sub(ship.position).normalize();}
    function fireGun(){const now=Date.now();if(curGun.rate&&now-lastFire<curGun.rate)return;lastFire=now;if(curGun.beam){if(!beamMesh)createBeam();return;}if(curGun.grav){createGravProj();return;}if(passives.MULTILOCK>0&&locked.length>0){locked.forEach((t,i)=>setTimeout(()=>createMLProj(t),i*30));return;}const d=aimDir();for(let i=0;i<(curGun.cnt||1);i++){const dir=d.clone();if(curGun.spread>0){dir.x+=(Math.random()-0.5)*curGun.spread;dir.y+=(Math.random()-0.5)*curGun.spread;dir.normalize();}createProj(ship.position.clone(),dir,curGun);}}
    function fireMissile(){const now=Date.now();if(!curMissile.inf&&mAmmo<=0)return;if(curMissile.rate&&now-lastFire<curMissile.rate)return;lastFire=now;if(curMissile.clear){if(mAmmo>0){triggerSmart();mAmmo--;updateMissileHUD();}return;}if(curMissile.rod){fireThor();return;}if(curMissile.multi&&locked.length>0){locked.forEach((t,i)=>setTimeout(()=>createMissile(t),i*50));if(!curMissile.inf)mAmmo=Math.max(0,mAmmo-locked.length);}else{createMissile(locked[0]||null);if(!curMissile.inf)mAmmo--;}updateMissileHUD();}
    function createProj(pos,dir,cfg){const g=new THREE.SphereGeometry(cfg.aoe?0.3:0.15,8,8);const m=new THREE.MeshBasicMaterial({color:cfg.col});const p=new THREE.Mesh(g,m);p.position.copy(pos);p.add(new THREE.PointLight(cfg.col,2,5));p.userData={dir:dir.clone(),spd:cfg.spd,life:cfg.life,start:Date.now(),dmg:cfg.dmg,cfg};scene.add(p);projs.push(p);}
    function createMLProj(tgt){const g=new THREE.SphereGeometry(0.2,8,8);const m=new THREE.MeshBasicMaterial({color:0xffaa00});const p=new THREE.Mesh(g,m);p.position.copy(ship.position);p.add(new THREE.PointLight(0xffaa00,2,4));p.userData={tgt,spd:curGun.spd*1.2,life:curGun.life,start:Date.now(),dmg:curGun.dmg,ml:true};scene.add(p);projs.push(p);}
    function createGravProj(){const g=new THREE.SphereGeometry(0.25,8,8);const m=new THREE.MeshBasicMaterial({color:curGun.col});const p=new THREE.Mesh(g,m);p.position.copy(ship.position);p.add(new THREE.PointLight(curGun.col,2,5));p.userData={dir:aimDir(),spd:curGun.spd,life:curGun.life,start:Date.now(),grav:true,cfg:curGun};scene.add(p);projs.push(p);}
    function createMissile(tgt){const g=new THREE.ConeGeometry(0.2,0.8,6);const m=new THREE.MeshBasicMaterial({color:curMissile.col});const ms=new THREE.Mesh(g,m);ms.position.copy(ship.position);ms.position.x+=(Math.random()-0.5)*2;ms.position.y+=(Math.random()-0.5)*2;ms.add(new THREE.PointLight(curMissile.col,2,3));ms.userData={tgt,vel:new THREE.Vector3(0,0,-curMissile.spd*0.5),spd:curMissile.spd,turn:curMissile.turn,life:curMissile.life,start:Date.now(),dmg:curMissile.dmg,bossOnly:curMissile.bossOnly};scene.add(ms);missiles.push(ms);}
    function createBeam(){if(beamMesh)return;const l=curGun.range;beamMesh=new THREE.Mesh(new THREE.CylinderGeometry(curGun.width*0.3,curGun.width*0.3,l,8),new THREE.MeshBasicMaterial({color:curGun.col,transparent:true,opacity:0.9}));const o=new THREE.Mesh(new THREE.CylinderGeometry(curGun.width,curGun.width,l,8),new THREE.MeshBasicMaterial({color:curGun.col,transparent:true,opacity:0.3}));beamMesh.add(o);scene.add(beamMesh);}
    function updateBeam(){if(!beamMesh)return;if(!input.fire||wType!=='gun'||!curGun.beam){scene.remove(beamMesh);beamMesh=null;return;}const d=aimDir();const l=curGun.range;const mid=ship.position.clone().add(d.clone().multiplyScalar(l/2));beamMesh.position.copy(mid);beamMesh.lookAt(ship.position.clone().add(d.clone().multiplyScalar(l)));beamMesh.rotateX(Math.PI/2);enemies.forEach(e=>{if(!e)return;const te=e.position.clone().sub(ship.position);const pr=te.dot(d);if(pr>0&&pr<l){const cp=ship.position.clone().add(d.clone().multiplyScalar(pr));if(e.position.distanceTo(cp)<curGun.width+(e.userData?.hr||1.5))dmgEnemy(e);}});}
    function createGravWell(anchor,cfg){const w=new THREE.Group();w.add(new THREE.Mesh(new THREE.SphereGeometry(0.8,16,16),new THREE.MeshBasicMaterial({color:cfg.col})));for(let i=1;i<=3;i++)w.add(new THREE.Mesh(new THREE.TorusGeometry(i*2.5,0.15,8,32),new THREE.MeshBasicMaterial({color:cfg.col,transparent:true,opacity:0.6/i})));w.add(new THREE.PointLight(cfg.col,5,cfg.grav));w.position.copy(anchor.position);w.userData={anchor,affected:new Set([anchor]),start:Date.now(),cfg,phase:'pull'};scene.add(w);gravWells.push(w);}
    function updateGravWells(dt){const now=Date.now();for(let i=gravWells.length-1;i>=0;i--){const w=gravWells[i];const d=w.userData;const el=now-d.start;if(d.anchor&&d.anchor.position)w.position.copy(d.anchor.position);w.rotation.z+=dt*3;w.children.forEach((c,j)=>{if(j>0&&j<=3)c.rotation.x+=dt*(j%2?2:-2);});if(d.phase==='pull'){enemies.forEach(e=>{if(!e||e===d.anchor)return;const dist=w.position.distanceTo(e.position);if(dist<d.cfg.grav&&dist>0.5){d.affected.add(e);const pd=w.position.clone().sub(e.position).normalize();e.position.add(pd.multiplyScalar(dt*40));}});if(el>d.cfg.delay)d.phase='collapse';}else if(d.phase==='collapse'){d.affected.forEach(e=>{if(enemies.includes(e))destroyEnemy(e,true);});const f=new THREE.Mesh(new THREE.SphereGeometry(d.cfg.grav*0.5,16,16),new THREE.MeshBasicMaterial({color:0xffffff,transparent:true,opacity:0.9}));f.position.copy(w.position);scene.add(f);setTimeout(()=>scene.remove(f),200);scene.remove(w);gravWells.splice(i,1);}}}
    function fireThor(){const tgts=locked.slice(0,curMissile.max||5);if(tgts.length===0&&autoLock)return;const actual=tgts.length>0?tgts:[{position:reticle.position.clone()}];actual.forEach(t=>{if(!t||!t.position)return;const pos=t.position.clone();const laser=new THREE.Mesh(new THREE.CylinderGeometry(0.15,0.15,1,6),new THREE.MeshBasicMaterial({color:0xff0000,transparent:true,opacity:0.8}));const dir=pos.clone().sub(ship.position);const len=dir.length();const mid=ship.position.clone().add(dir.clone().multiplyScalar(0.5));laser.position.copy(mid);laser.scale.y=len;laser.lookAt(pos);laser.rotateX(Math.PI/2);scene.add(laser);const rod=new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.1,100,8),new THREE.MeshBasicMaterial({color:0xffffff,transparent:true,opacity:0.9}));rod.position.set(pos.x,pos.y+50,pos.z);scene.add(rod);const imp=new THREE.PointLight(0xffffff,50,30);imp.position.copy(pos);scene.add(imp);const ring=new THREE.Mesh(new THREE.RingGeometry(0,10,32),new THREE.MeshBasicMaterial({color:0x00ffff,transparent:true,opacity:0.7,side:2}));ring.position.set(pos.x,-4.9,pos.z);ring.rotation.x=-Math.PI/2;scene.add(ring);if(t.userData){dmgEnemy(t);t.position.y=Math.max(-4,t.position.y-5);}setTimeout(()=>{scene.remove(laser);scene.remove(rod);scene.remove(imp);scene.remove(ring);},500);});}
    function triggerSmart(){const sp=new THREE.Mesh(new THREE.SphereGeometry(1,32,32),new THREE.MeshBasicMaterial({color:0xffffff,transparent:true,opacity:1}));sp.position.copy(ship.position);scene.add(sp);let sc=0;const iv=setInterval(()=>{sc+=10;sp.scale.set(sc,sc,sc);sp.material.opacity=1-sc/200;if(sc>=200){clearInterval(iv);scene.remove(sp);}},16);enemies.forEach(e=>{if(e.userData?.boss&&curMissile.boss)return;dmgEnemy(e);});showMsg('SMARTBOMB!','#fff');}
    function updateProjs(dt){const now=Date.now();for(let i=projs.length-1;i>=0;i--){const p=projs[i];const d=p.userData;if(d.ml&&d.tgt&&d.tgt.position){const toT=d.tgt.position.clone().sub(p.position).normalize();p.position.add(toT.multiplyScalar(d.spd*dt));if(p.position.distanceTo(d.tgt.position)<2){dmgEnemy(d.tgt);scene.remove(p);projs.splice(i,1);continue;}}else if(d.grav){p.position.add(d.dir.clone().multiplyScalar(d.spd*dt));enemies.forEach(e=>{if(!e||d.attached)return;if(p.position.distanceTo(e.position)<(e.userData?.hr||1.5)){d.attached=true;createGravWell(e,d.cfg);scene.remove(p);projs.splice(i,1);}});}else{p.position.add(d.dir.clone().multiplyScalar(d.spd*dt));enemies.forEach(e=>{if(!e)return;if(p.position.distanceTo(e.position)<(e.userData?.hr||1.5)){dmgEnemy(e);if(d.cfg?.chain)chainLightning(p.position.clone(),d.cfg,[e]);scene.remove(p);projs.splice(i,1);}});}if(now-d.start>d.life){scene.remove(p);projs.splice(i,1);}}}
    function chainLightning(pos,cfg,hit){let cur=pos.clone();let cnt=0;while(cnt<(cfg.chain||4)){let near=null,nearD=15;enemies.forEach(e=>{if(!e||hit.includes(e))return;const dist=cur.distanceTo(e.position);if(dist<nearD){nearD=dist;near=e;}});if(!near)break;const pts=[];for(let i=0;i<=8;i++){const t=i/8;const pt=cur.clone().lerp(near.position,t);pt.x+=(Math.random()-0.5)*2;pt.y+=(Math.random()-0.5)*2;pts.push(pt);}const arc=new THREE.Line(new THREE.BufferGeometry().setFromPoints(pts),new THREE.LineBasicMaterial({color:cfg.col}));scene.add(arc);setTimeout(()=>scene.remove(arc),200);dmgEnemy(near);hit.push(near);cur=near.position.clone();cnt++;}}
    function updateMissiles(dt){const now=Date.now();for(let i=missiles.length-1;i>=0;i--){const m=missiles[i];const d=m.userData;if(d.tgt&&d.tgt.position){const toT=d.tgt.position.clone().sub(m.position).normalize();const curD=d.vel.clone().normalize();const newD=curD.lerp(toT,d.turn*dt);d.vel=newD.multiplyScalar(d.spd);}m.position.add(d.vel.clone().multiplyScalar(dt));if(d.vel.length()>0){m.lookAt(m.position.clone().add(d.vel));m.rotateX(Math.PI/2);}if(d.tgt&&d.tgt.position){const dist=m.position.distanceTo(d.tgt.position);if(dist<(d.tgt.userData?.hr||2)){if(!d.bossOnly||d.tgt.userData?.boss)dmgEnemy(d.tgt);scene.remove(m);missiles.splice(i,1);continue;}}if(now-d.start>d.life){scene.remove(m);missiles.splice(i,1);}}}
    function updateLockInd(){scene.children.filter(c=>c.userData?.lock).forEach(c=>scene.remove(c));if(!autoLock)return;const ml=passives.MULTILOCK>0;locked.forEach((t,j)=>{if(!t||!t.position)return;const ind=new THREE.Group();ind.userData={lock:true};const col=ml?0xffaa00:j===tgtIdx?0xff0000:0xff8800;const sz=j===tgtIdx?3:2;ind.add(new THREE.Mesh(new THREE.RingGeometry(sz*0.8,sz,4),new THREE.MeshBasicMaterial({color:col,transparent:true,opacity:0.8,side:2})));const r2=new THREE.Mesh(new THREE.RingGeometry(sz*0.5,sz*0.65,4),new THREE.MeshBasicMaterial({color:col,transparent:true,opacity:0.6,side:2}));r2.rotation.z=Math.PI/4;ind.add(r2);if(ml)ind.add(new THREE.Mesh(new THREE.RingGeometry(sz*1.1,sz*1.2,8),new THREE.MeshBasicMaterial({color:col,transparent:true,opacity:0.4,side:2})));ind.position.copy(t.position);scene.add(ind);});}
    function showMsg(txt,col='#0f8'){const m=document.getElementById('message');m.textContent=txt;m.style.color=col;m.classList.add('visible');setTimeout(()=>m.classList.remove('visible'),1500);}
    let lastTime=performance.now();
    function animate(){requestAnimationFrame(animate);const now=performance.now();const dt=Math.min((now-lastTime)/1000,0.1);lastTime=now;input.mx=(keys.KeyD||keys.ArrowRight)?1:(keys.KeyA||keys.ArrowLeft)?-1:0;input.my=(keys.KeyW||keys.ArrowUp)?1:(keys.KeyS||keys.ArrowDown)?-1:0;const n=Date.now();if(input.sw&&!wLocked&&n-lastSwitch>300){lastSwitch=n;wType=wType==='gun'?'missile':'gun';updateWType();showMsg(wType.toUpperCase(),wType==='gun'?'#0f8':'#f40');}if(input.tog&&n-lastToggle>300){lastToggle=n;autoLock=!autoLock;document.getElementById('targeting-mode').className=autoLock?'auto':'';document.getElementById('targeting-mode').textContent=autoLock?'â—‰ AUTO-LOCK':'â—‹ MANUAL';showMsg(autoLock?'AUTO-LOCK':'MANUAL',autoLock?'#f44':'#888');}if(input.cn)cycleTgt(1);if(input.cp)cycleTgt(-1);const spd=passives.OVERDRIVE>0?30:15;ship.position.x+=input.mx*spd*dt;ship.position.y+=input.my*spd*dt;ship.position.x=Math.max(-15,Math.min(15,ship.position.x));ship.position.y=Math.max(-8,Math.min(8,ship.position.y));ship.rotation.x=-input.my*0.3;ship.rotation.z=input.mx*0.4;reticle.position.x=ship.position.x+input.ax*15;reticle.position.y=ship.position.y+input.ay*10;reticle.position.z=ship.position.z-50;reticle.rotation.z+=dt*2;if(autoLock)updateTgt();if(input.fire){if(wType==='gun')fireGun();else fireMissile();}updateBeam();updateProjs(dt);updateMissiles(dt);updateGravWells(dt);updateLockInd();if(gunTimer>0){gunTimer-=dt*1000;if(gunTimer<=0){gunTimer=0;curGun=GUNS.RAPID;showMsg('GUN EXPIRED','#888');}updateGunHUD();}if(missileTimer>0){missileTimer-=dt*1000;if(missileTimer<=0){missileTimer=0;curMissile=MISSILES.HELLFIRE;mAmmo=curMissile.ammo;showMsg('MISSILE EXPIRED','#888');}updateMissileHUD();}Object.keys(passives).forEach(k=>{if(passives[k]>0){passives[k]-=dt*1000;if(passives[k]<=0){delete passives[k];if(k==='MULTILOCK'){wLocked=false;document.getElementById('wlock').style.display='none';}showMsg(k+' EXPIRED','#888');}}});updatePassivesHUD();if(reloading){const prog=(n-reloadStart)/curMissile.reload;document.getElementById('missile-fill').style.width=prog*100+'%';if(prog>=1){reloading=false;mAmmo=curMissile.ammo;updateMissileHUD();}}else if(mAmmo<=0&&curMissile.reload&&!curMissile.inf){reloading=true;reloadStart=n;document.getElementById('missile-timer').style.display='block';showMsg('RELOADING','#f40');}enemies.forEach(e=>{if(e){e.rotation.y+=dt*0.5;e.rotation.x+=dt*0.3;}});camera.position.x+=(ship.position.x*0.3-camera.position.x)*0.05;camera.position.y+=((ship.position.y+8)-camera.position.y)*0.05;renderer.render(scene,camera);}
    window.addEventListener('DOMContentLoaded',()=>{init();setTimeout(()=>spawnWave(5),1000);document.getElementById('game-canvas').focus();});
  </script>
</body>
</html>
